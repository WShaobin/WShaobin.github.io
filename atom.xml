<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Wynsbin</title>
  
  <subtitle>低调做人，高调做事</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://wshaobin.github.io/"/>
  <updated>2019-10-24T07:15:48.180Z</updated>
  <id>https://wshaobin.github.io/</id>
  
  <author>
    <name>Wynsbin</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Git工作流程+常用命令</title>
    <link href="https://wshaobin.github.io/2019/10/24/git-command/"/>
    <id>https://wshaobin.github.io/2019/10/24/git-command/</id>
    <published>2019-10-24T03:55:16.000Z</published>
    <updated>2019-10-24T07:15:48.180Z</updated>
    
    <content type="html"><![CDATA[<p>Git工作流程+常用命令流程图</p><a id="more"></a><h2 id="Git工作流程"><a href="#Git工作流程" class="headerlink" title="Git工作流程"></a>Git工作流程</h2><p><img src="/images/article/git_work.webp" alt="在这里插入图片描述"></p><p>以上包括一些简单而常用的命令，但是先不关心这些，先来了解下面这4个专有名词。</p><ul><li>Workspace：工作区</li><li>Index / Stage：暂存区</li><li>Repository：仓库区（或本地仓库）</li><li>Remote：远程仓库</li></ul><h2 id="Git常用命令"><a href="#Git常用命令" class="headerlink" title="Git常用命令"></a>Git常用命令</h2><p><img src="/images/article/git_command.webp" alt="在这里插入图片描述"></p><p><strong>参考</strong></p><p><a href="https://www.jianshu.com/p/9685a56bdf7a" target="_blank" rel="noopener">Git最全命令</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Git工作流程+常用命令流程图&lt;/p&gt;
    
    </summary>
    
      <category term="Git" scheme="https://wshaobin.github.io/categories/Git/"/>
    
    
      <category term="Git" scheme="https://wshaobin.github.io/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>Chrome打开应用商店及推荐实用插件</title>
    <link href="https://wshaobin.github.io/2019/01/08/chrome-plugin/"/>
    <id>https://wshaobin.github.io/2019/01/08/chrome-plugin/</id>
    <published>2019-01-08T08:12:16.000Z</published>
    <updated>2019-10-24T06:39:43.491Z</updated>
    
    <content type="html"><![CDATA[<p>解决Chrome打不开的问题，推荐开发使用的优质插件</p><a id="more"></a><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><ol><li>通过修改hosts文件等等 </li><li>谷歌访问助手，根据自己使用的浏览器点击对应版本的插件，<a href="http://www.ggfwzs.com/" target="_blank" rel="noopener">下载地址</a></li></ol><h2 id="实用插件"><a href="#实用插件" class="headerlink" title="实用插件"></a>实用插件</h2><ol><li><a href="https://chrome.google.com/webstore/detail/%E4%BA%8C%E7%BB%B4%E7%A0%81qr%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8qr-code-generato/pflgjjogbmmcmfhfcnlohagkablhbpmg" target="_blank" rel="noopener">二维码(QR码)生成器 </a></li><li><a href="https://chrome.google.com/webstore/detail/user-agent-switcher-for-g/ffhkkpnppgnfaobgihpdblnhmmbodake" target="_blank" rel="noopener">模拟其他浏览器访问的谷歌浏览器 </a></li><li><a href="https://chrome.google.com/webstore/detail/postman-interceptor/aicmkgpgakddgnaphhhpliifpcfhicfo" target="_blank" rel="noopener">网络请求：Postman</a></li><li><a href="https://chrome.google.com/webstore/detail/adblock-plus/cfhdojbkjhnklbpkdaibdccddilifddb" target="_blank" rel="noopener">过滤广告：Adblock Plus</a></li><li><a href="https://chrome.google.com/webstore/detail/octotree/bkhaagjahfmjljalopjnoealnfndnagc?utm_source=chrome-ntp-icon" target="_blank" rel="noopener">方便 github 项目结构查看 </a></li><li><a href="https://chrome.google.com/webstore/detail/json-handle/iahnhfdhidomcpggpaimmmahffihkfnj?utm_source=chrome-ntp-icon" target="_blank" rel="noopener">json结构树查看 </a></li><li><a href="https://chrome.google.com/webstore/detail/%E5%88%92%E8%AF%8D%E7%BF%BB%E8%AF%91/ikhdkkncnoglghljlkmcimlnlhkeamad?utm_source=chrome-ntp-icon" target="_blank" rel="noopener">划词翻译 </a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;解决Chrome打不开的问题，推荐开发使用的优质插件&lt;/p&gt;
    
    </summary>
    
      <category term="Chrome" scheme="https://wshaobin.github.io/categories/Chrome/"/>
    
    
      <category term="Chrome" scheme="https://wshaobin.github.io/tags/Chrome/"/>
    
  </entry>
  
  <entry>
    <title>Git上传本地项目到Github</title>
    <link href="https://wshaobin.github.io/2018/12/22/git-upload-project/"/>
    <id>https://wshaobin.github.io/2018/12/22/git-upload-project/</id>
    <published>2018-12-22T06:45:06.000Z</published>
    <updated>2019-10-24T07:18:13.860Z</updated>
    
    <content type="html"><![CDATA[<p>全网最详细的介绍，如何用Git的方式把项目上传本地项目到Github</p><a id="more"></a><h2 id="创建本地版本库"><a href="#创建本地版本库" class="headerlink" title="创建本地版本库"></a>创建本地版本库</h2><p>其实这里就是你要上传的那个项目文件（例如：Project）</p><h2 id="Git初始化"><a href="#Git初始化" class="headerlink" title="Git初始化"></a>Git初始化</h2><p>对着Project右键,选择Git bash here,通过命令<code>git init</code>把这个文件夹变成Git可管理的仓库</p><p><img src="/images/article/git_1.png" alt="在这里插入图片描述"></p><p>这时你会发现Project里面多了个.git文件夹，它是Git用来跟踪和管理版本库的。如果你看不到，是因为它默认是隐藏文件，那你就需要设置一下让隐藏文件可见。</p><h2 id="项目添加到本地仓库"><a href="#项目添加到本地仓库" class="headerlink" title="项目添加到本地仓库"></a>项目添加到本地仓库</h2><p>你的项目粘贴到这个本地Git仓库里面（粘贴后你可以通过<code>git status</code>来查看你当前的状态），然后通过git add把项目添加到仓库（或<code>git add .</code>把该目录下的所有文件添加到仓库，注意点是用空格隔开的）。在这个过程中你其实可以一直使用git status来查看你当前的状态。</p><h2 id="提交到仓库"><a href="#提交到仓库" class="headerlink" title="提交到仓库"></a>提交到仓库</h2><p>用git commit把项目提交到仓库，<code>-m</code>后面引号里面是本次提交的注释内容,命令如下</p><p><code>git commit -m &quot;注解内容&quot;</code></p><p><strong>下面就是上传了，如果没有配置SSH的话，可以先配置一下，这里不做详细的介绍了</strong></p><p><img src="/images/article/git_2.png" alt="在这里插入图片描述"></p><h2 id="创建远程仓库"><a href="#创建远程仓库" class="headerlink" title="创建远程仓库"></a>创建远程仓库</h2><p>在Github上创建一个Git仓库，你可以直接点New repository来创建，比如我创建了一个Project的仓库</p><h2 id="关联本地仓库"><a href="#关联本地仓库" class="headerlink" title="关联本地仓库"></a>关联本地仓库</h2><p>在Github上创建好Git仓库之后我们就可以和本地仓库进行关联了，根据创建好的Git仓库页面的提示，可以在本地Project仓库的命令行输入：</p><p><code>git remote add origin https://github.com/WShaobin/Project.git</code></p><p>这里可以是HTTPS或者SSH,二则选其一就行</p><h2 id="推送到远程仓库"><a href="#推送到远程仓库" class="headerlink" title="推送到远程仓库"></a>推送到远程仓库</h2><p>关联好之后我们就可以把本地库的所有内容推送到远程仓库（也就是Github）上了，通过：</p><p><code>git push -u origin master</code></p><p> 由于新建的远程仓库是空的，所以要加上<code>-u</code>这个参数，等远程仓库里面有了内容之后，下次再从本地库上传内容的时候只需下面这样就可以了：</p><p> <code>git push origin master</code></p><p>至此就完成了将本地项目上传到Github的整个过程。</p><p>另外，如果你在git push 的时候出现如下报错。<br><img src="/images/article/git_3.png" alt="在这里插入图片描述"></p><p>原因是你勾选了Initialize this repository with a README，就是创建仓库的时候自动给你创建一个README文件，而本地仓库没有README文件，这时我们可以通过以下命令先将内容合并以下：</p><p><code>git pull --rebase origin master</code></p><p>然后重新push就成功了</p><h2 id="Git忽略"><a href="#Git忽略" class="headerlink" title="Git忽略"></a>Git忽略</h2><h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><p>在添加.gitignore文件后，当想push文件的时候，声明的忽略文件还是会出现在push的目录中</p><h3 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h3><p>某些文件已经被纳入版本管理中，就算是在.gitignore中已经声明也不会起作用</p><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>我们应该先把本地的缓存删除，然后再进行push，操作步骤如下</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git rm -r --cached . <span class="comment">// 删除本地缓存</span></span><br><span class="line">git <span class="keyword">add</span> . <span class="comment">// 添加要提交的文件</span></span><br><span class="line">git commit -m <span class="string">'update .gitignore'</span> <span class="comment">// 更新本地的缓存</span></span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="初次上传"><a href="#初次上传" class="headerlink" title="初次上传"></a>初次上传</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">git <span class="keyword">add</span><span class="bash"> .</span></span><br><span class="line"><span class="bash">git commit -m <span class="string">"注解内容"</span></span></span><br><span class="line"><span class="bash">git remote add origin https://github.com/xxx/xxx.git</span></span><br><span class="line"><span class="bash">git push -u origin master</span></span><br></pre></td></tr></table></figure><p>如果git push时，报了git pull…的错，可以使用如下命令：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull <span class="comment">--rebase origin master</span></span><br></pre></td></tr></table></figure><h3 id="二次上传"><a href="#二次上传" class="headerlink" title="二次上传"></a>二次上传</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">git</span> <span class="keyword">add </span>.</span><br><span class="line"><span class="symbol">git</span> commit -m <span class="string">"注解内容"</span></span><br><span class="line"><span class="symbol">git</span> <span class="keyword">push </span>origin master</span><br></pre></td></tr></table></figure><p><strong>参考</strong></p><p><a href="https://blog.csdn.net/zamamiro/article/details/70172900" target="_blank" rel="noopener">Git上传项目</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;全网最详细的介绍，如何用Git的方式把项目上传本地项目到Github&lt;/p&gt;
    
    </summary>
    
      <category term="Git" scheme="https://wshaobin.github.io/categories/Git/"/>
    
    
      <category term="Git" scheme="https://wshaobin.github.io/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>Android反编译Apk，修改资源，重新打包，签名发布</title>
    <link href="https://wshaobin.github.io/2018/12/22/decompile-apk-1/"/>
    <id>https://wshaobin.github.io/2018/12/22/decompile-apk-1/</id>
    <published>2018-12-22T03:24:49.000Z</published>
    <updated>2019-10-22T01:19:05.501Z</updated>
    
    <content type="html"><![CDATA[<p>本文简单介绍apk是如何修改logo（ic_launcher），类似的资源文件修改也可以通过此方式。不过要修改class的话就要涉及到smali的学习了，这里就暂且不谈，后续有需要再做更新。<br><a id="more"></a></p><h2 id="工具介绍"><a href="#工具介绍" class="headerlink" title="工具介绍"></a>工具介绍</h2><p><img src="/images/article/decompile_apk_1_1.png" alt="在这里插入图片描述"></p><ul><li>apktool：用来反编译apk，apk重新打包</li><li>autosign：自动签名工具，将重新打包的apk进行签名，如果不签名，无法安装使用</li><li>jadx-0.6.1-dev-build226：查看源码及目录结构，相当于dex2jar + jd-gui<br>这些工具在网上都可以下载的到，如果需要的话留下邮箱即可</li></ul><h2 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h2><h3 id="jadx-0-6-1-dev-build226"><a href="#jadx-0-6-1-dev-build226" class="headerlink" title="jadx-0.6.1-dev-build226"></a>jadx-0.6.1-dev-build226</h3><p>双击jadx-0.6.1-dev-build226\bin目录下jadx-gui.bat,选择test.apk即可看到源码及目录结构，如下<br><img src="/images/article/decompile_apk_1_2.png" alt="在这里插入图片描述"><br>这只是用于查看源码，并起不到修改作用，不过可以查看要修改的东西在哪个位置，真正修改要通过apktool反编译apk的源码才可以修改。</p><h3 id="apktool"><a href="#apktool" class="headerlink" title="apktool"></a>apktool</h3><p> 该目录下有三个文件：aapt.exe，apktool.bat，apktool.jar ，将需要反编译的APK文件放到该目录下，如图：<br><img src="/images/article/decompile_apk_1_3.png" alt="在这里插入图片描述"><br>在该目录下，按住Shift，然后右键选择“在此处打开命令窗口”，输入一下命令：</p><p><code>apktool.bat d -f test.apk -o test</code></p><p>apktool -f [待反编译的apk] -o [反编译之后存放文件夹]<br><img src="/images/article/decompile_apk_1_4.png" alt="在这里插入图片描述"><br>如果反编译过程中遇到Exception in thread “main” 错误，可能是apktool.jar的版本太低，使用高版本不会出现异常。</p><p>请往<a href="https://ibotpeaches.github.io/Apktool/" target="_blank" rel="noopener">https://ibotpeaches.github.io/Apktool/</a></p><p>重新下载，下载到的apktool_xxx.jar文件改名为apktool.jar，然后替换掉老版本的apktool.jar，重新执行命令应该就正常了。</p><p>反编译之后会得到test 文件夹，打开test文件夹，里边就是反编译出来的各种资源文件<br><img src="/images/article/decompile_apk_1_5.png" alt="在这里插入图片描述"><br>然后进行test\res目录去修改ic_launcher，这里所有的ic_launcher都要做替换。</p><p>修改成功，保存，重新打包，执行打包命令</p><p><code>apktool.bat b test</code></p><p>在test文件内会多出两个文件如下图所示：<br><img src="/images/article/decompile_apk_1_6.png" alt="在这里插入图片描述"><br>dist文件内就是我们需要的apk。</p><h3 id="autosign"><a href="#autosign" class="headerlink" title="autosign"></a>autosign</h3><p>签名apk，重新发布</p><p>接下来就要用到签名工具了，如果不经过签名是不能正确运行的。工具： auto-sign.zip</p><p>将打包好的test.apk 拷贝到解压好的auto-sign文件夹下，执行命令：</p><p><code>java -jar signapk.jar testkey.x509.pem testkey.pk8 test.apk test_signed.apk</code></p><p>test_signed.apk就是签名后的apk </p><p>到此修改资源文件就大功告成了，也是很简单的</p><p>参考：<a href="https://blog.csdn.net/sxk874890728/article/details/80486223" target="_blank" rel="noopener">https://blog.csdn.net/sxk874890728/article/details/80486223</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文简单介绍apk是如何修改logo（ic_launcher），类似的资源文件修改也可以通过此方式。不过要修改class的话就要涉及到smali的学习了，这里就暂且不谈，后续有需要再做更新。&lt;br&gt;
    
    </summary>
    
      <category term="Android" scheme="https://wshaobin.github.io/categories/Android/"/>
    
    
      <category term="Android" scheme="https://wshaobin.github.io/tags/Android/"/>
    
      <category term="反编译" scheme="https://wshaobin.github.io/tags/%E5%8F%8D%E7%BC%96%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Hexo主题Next的个性化教程，打造炫酷网站</title>
    <link href="https://wshaobin.github.io/2018/12/20/hexo-2/"/>
    <id>https://wshaobin.github.io/2018/12/20/hexo-2/</id>
    <published>2018-12-20T07:30:02.000Z</published>
    <updated>2019-10-23T07:12:10.155Z</updated>
    
    <content type="html"><![CDATA[<p>在学习搭建Hexo网站的时候，看到很多人用着炫酷的效果,特意搜了一下，发现网上确实有很多教程，这里就不一一说明，只列举处对应的功能。</p><a id="more"></a><ul><li>在右上角或者左上角实现fork me on github</li><li>添加RSS</li><li>添加动态背景(<code>themes\next\_config.yml</code>搜<code>canvas_</code>把值改为true)</li><li>实现点击出现桃心效果</li><li>修改文章内链接文本样式</li><li>修改文章底部的那个带#号的标签</li><li>在每篇文章末尾统一添加“本文结束”标记</li><li>修改作者头像并旋转</li><li>博文压缩</li><li>修改代码块自定义样式</li><li>侧边栏社交小图标设置</li><li>主页文章添加阴影效果</li><li>在网站底部加上访问量</li><li>添加热度</li><li>网站底部字数统计</li><li>添加 README.md 文件</li><li>设置网站的图标Favicon</li><li>实现统计功能</li><li>添加顶部加载条</li><li>添加网易云跟帖(跟帖关闭，已失效，改为来必力)</li><li>隐藏网页底部powered By Hexo / 强力驱动</li><li>修改网页底部的桃心</li><li>文章加密访问</li><li>添加jiathis分享（jia this已经宣布关闭，个人用的是<a href="https://blog.csdn.net/cl534854121/article/details/76121105" target="_blank" rel="noopener">baidushare</a>）</li><li>修改字体大小</li><li>修改打赏字体不闪动</li><li>自定义鼠标样式</li><li>为博客加上萌萌的宠物（注意：<code>_config.yml</code>是根目录的）</li><li>DaoVoice 在线联系</li><li>点击爆炸效果</li><li>添加更多的menu内容</li><li><a href="https://github.com/metowolf/MetingJS" target="_blank" rel="noopener">添加网易云音乐</a> (<a href="https://www.znian.cn/2249.html" target="_blank" rel="noopener">其中id为歌单Id</a>)</li><li>文章置顶+置顶标签</li><li>当前浏览进度<br>  <code>themes\next\_config.yml</code>搜<code>scrollpercent</code>改为true。    如果想要在侧边栏显示，则搜b2t改为true</li><li><p>RSS下的社交平台<br>  在<code>themes\next\_config.yml</code>中搜索<code>social</code>,开启social及修改对应的值<br>  平台链接后面的<code>||</code>指的是<a href="http://fontawesome.dashgame.com/" target="_blank" rel="noopener">Font Awesome图标字体库</a></p>  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">social:</span></span><br><span class="line"><span class="attr">  GitHub:</span> <span class="attr">https://github.com/WShaobin</span> <span class="string">||</span> <span class="string">github</span></span><br><span class="line"><span class="attr">  E-Mail:</span> <span class="attr">http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=EyQnISAqJSslJFNiYj1wfH4</span> <span class="string">||</span> <span class="string">envelope</span></span><br><span class="line"><span class="attr">  CSDN:</span> <span class="attr">https://blog.csdn.net/qq_30552993</span> <span class="string">||</span> <span class="string">codiepie</span></span><br><span class="line">  <span class="string">简书:</span> <span class="attr">https://www.jianshu.com/u/c9c7b1275142</span> <span class="string">||</span> <span class="string">gratipay</span></span><br><span class="line"><span class="attr">social_icons:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  icons_only:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  transition:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></li><li><p>添加友情链接<br>  进入<code>themes\next\layout\_macro\slidebar.swig</code></p>  <figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> theme.social %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">......</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>  这以上代码下添加下面内容，修改成自己想要的内容</p>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"links-of-blogroll motion-element links-of-blogroll-inline"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"links-of-blogroll-title"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa  fa-fw fa-globe"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">  友情链接</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"links-of-blogroll-list"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"links-of-blogroll-item"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://xxx"</span> <span class="attr">title</span>=<span class="string">"xxx"</span> <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><a href="https://hexo.io/docs/front-matter.html" target="_blank" rel="noopener">修改文章模版Front-matter</a><br>  根目录<code>scaffolds\post.md</code>添加tags,categories等</p>  <figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">title: &#123;&#123; title &#125;&#125;</span><br><span class="line">date: &#123;&#123; date &#125;&#125;</span><br><span class="line"><span class="keyword">tags:</span> []</span><br><span class="line">categories: []</span><br></pre></td></tr></table></figure></li><li><p>添加cnzz站点统计<br>  找到<code>themes\next\layout\_partials\footer.swig</code>，在内容的最上面添加统计代码<code>&lt;script&gt;......&lt;/script&gt;</code></p></li><li>文章底部添加版权信息<br>  开启方式：<code>themes\next\_config.yml</code>，搜<code>post_copyright</code>，将enable改成true<br>  版权信息布局：<code>themes\next\layout\_macro\post-copyright.swig</code><br>  修改字体信息：<code>themes\next\languages\zh-Hans.yml</code>,搜索<code>copyright</code><br>  如果本文链接为<code>http://yoursite.com</code>，请到根目录<code>_config.yml</code>修改url为<code>https://xxx.github.io</code> （自己的网址）</li></ul><p>参考:<br><a href="https://www.jianshu.com/p/f054333ac9e6" target="_blank" rel="noopener">https://www.jianshu.com/p/f054333ac9e6</a><br><a href="http://theme-next.iissnan.com/getting-started.html" target="_blank" rel="noopener">http://theme-next.iissnan.com/getting-started.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在学习搭建Hexo网站的时候，看到很多人用着炫酷的效果,特意搜了一下，发现网上确实有很多教程，这里就不一一说明，只列举处对应的功能。&lt;/p&gt;
    
    </summary>
    
      <category term="Hexo" scheme="https://wshaobin.github.io/categories/Hexo/"/>
    
    
      <category term="Hexo" scheme="https://wshaobin.github.io/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>Hexo+Github搭建博客心得篇</title>
    <link href="https://wshaobin.github.io/2018/12/20/hexo-1/"/>
    <id>https://wshaobin.github.io/2018/12/20/hexo-1/</id>
    <published>2018-12-20T07:29:58.000Z</published>
    <updated>2019-10-23T06:54:48.187Z</updated>
    
    <content type="html"><![CDATA[<p>以前都是在CSDN上写博客，就想着何时自己搭建一个博客，终于通过借鉴和看了很多大神的文章，开启了Hexo+Github搭建博客，这里跟大家分享一些心得。<br><a id="more"></a></p><h2 id="安装和配置Node-js"><a href="#安装和配置Node-js" class="headerlink" title="安装和配置Node.js"></a>安装和配置Node.js</h2><p><a href="https://nodejs.org/en/" target="_blank" rel="noopener">Node.js官网</a></p><p>安装成功之后，打开cmd，运行以下两个命令<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">node</span> <span class="title">-v</span></span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure></p><p>出现对应的版本即表示安装成功，再运行<br><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">path</span></span><br></pre></td></tr></table></figure></p><p><img src="/images/article/hexo_1_1.png" alt="在这里插入图片描述"></p><p>如果看到nodejs字样证明配置环境成功</p><h2 id="安装和配置Git"><a href="#安装和配置Git" class="headerlink" title="安装和配置Git"></a>安装和配置Git</h2><p>安装成功之后，桌面右键选择Git Bash Here,运行以下命令</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="comment">--version</span></span><br></pre></td></tr></table></figure><p>出现对应的版本号，说明已经成功了。</p><h2 id="Github上新建项目"><a href="#Github上新建项目" class="headerlink" title="Github上新建项目"></a>Github上新建项目</h2><p>在Github右上角【+】，选择new repository。项目必须要遵守格式：账户名.github.io，不然接下来会有很多麻烦。并且需要勾选Initialize this repository with a README</p><p><img src="/images/article/hexo_1_2.png" alt="在这里插入图片描述"></p><p>在建好的项目右侧有个settings按钮，点击它，向下拉到GitHub Pages，你会看到那边有个网址，访问它，你将会惊奇的发现该项目已经被部署到网络上，能够通过外网来访问它。(https:// 账户名.github.io)</p><h2 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h2><p>1、在自己认为合适的地方创个文件夹，我是在D盘建了一个blog文件夹。</p><p>然后通过命令行进入到该文件夹里面</p><ul><li>输入<code>npm install hexo -g</code>，开始安装Hexo，不过很卡请看第二点</li><li>输入<code>hexo -v</code>，检查hexo是否安装成功</li><li>输入<code>hexo init</code>，初始化该文件夹（有点漫长的等待。。。）</li></ul><p>2、如果npm安装Hexo卡顿，npm使用国内镜像，以管理员身份运行命令提示符</p><ul><li>换成阿里源<br><code>npm config set registry https://registry.npm.taobao.org</code></li><li>验证命令<br><code>npm config get registry  //返回https://registry.npm.taobao.org，说明镜像配置成功。</code></li><li>安装cnpm<br><code>npm install -g cnpm --registry=https://registry.npm.taobao.org</code></li></ul><p>3、看到后面的“Start blogging with Hexo！”，则说明初始化成功。</p><ul><li>输入<code>npm install</code>，安装所需要的组件</li><li>输入<code>hexo g</code>，首次体验Hexo</li><li>输入<code>hexo s</code>，开启服务器，访问该网址，正式体验Hexo</li></ul><p><img src="/images/article/hexo_1_3.png" alt="在这里插入图片描述"></p><p><strong>注意：开启之后，别把cmd窗口关闭，要不然就访问不了<a href="http://localhost:4000" target="_blank" rel="noopener">http://localhost:4000</a></strong></p><p>问题：假如页面一直无法跳转，那么可能端口被占用了。此时我们ctrl+c停止服务器，接着输入“<code>hexo server -p 端口号</code>”来改变端口号</p><h2 id="Git绑定Github账号"><a href="#Git绑定Github账号" class="headerlink" title="Git绑定Github账号"></a>Git绑定Github账号</h2><p>在blog文件里面，右键Git Base Here<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git<span class="built_in"> config </span>--global user.name “账号”</span><br><span class="line">$ git<span class="built_in"> config </span>--global user.email “邮箱”</span><br><span class="line">$ cd ~/.ssh</span><br></pre></td></tr></table></figure></p><p>输入ls，如果出现id_ras id_ras.pub….，则表示密钥已存在</p><p>若不存在，则输入ssh-keygen -t rsa -C “<a href="mailto:xxx@qq.com" target="_blank" rel="noopener">xxx@qq.com</a>”，连续三个回车，生成密钥，最后得到了两个文件：id_rsa和id_rsa.pub（默认存储路径是：C:\Users\Administrator.ssh）。</p><p>登录Github，点击头像下的settings，点击侧边栏SSH and GPG keys，再点击Add SSH Key，在title处填入任意的标识，在Key部分里面添加刚才复制的id_rsa.pub文件里的内容，点击添加即可</p><p>输入ssh -T <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>，测试添加ssh是否成功<br><img src="/images/article/hexo_1_4.png" alt="在这里插入图片描述"></p><h2 id="配置Deployment"><a href="#配置Deployment" class="headerlink" title="配置Deployment"></a>配置Deployment</h2><p>在blog目录下，找到_config.yml文件，修改repo值（在末尾）<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">deploy</span>:</span><br><span class="line"><span class="attribute">type</span>: git </span><br><span class="line"><span class="attribute">repository</span>: git<span class="variable">@github</span>.<span class="attribute">com</span>:WShaobin/WShaobin.github.io.git</span><br><span class="line"><span class="attribute">branch</span>: master</span><br></pre></td></tr></table></figure></p><p>repository值是你在github项目里的ssh（右下角）<br><img src="/images/article/hexo_1_5.png" alt="在这里插入图片描述"></p><h2 id="新建一篇博客"><a href="#新建一篇博客" class="headerlink" title="新建一篇博客"></a>新建一篇博客</h2><p>右键git bash here执行命令：<code>hexo new post “文章”</code>或<code>hexo new “文章”</code></p><p>这时候在文件夹_posts目录下将会看到已经创建的文件</p><p>在生成以及部署文章之前，需要安装一个扩展：<code>npm install hexo-deployer-git --save</code></p><p>使用编辑器编好文章，那么就可以使用命令：<code>hexo d -g</code>，生成以及部署了</p><p>部署成功后访问你的地址：http://用户名.github.io。那么将看到生成的文章<br><img src="/images/article/hexo_1_6.png" alt="在这里插入图片描述"></p><h2 id="添加搜索功能"><a href="#添加搜索功能" class="headerlink" title="添加搜索功能"></a>添加搜索功能</h2><p>进入blog目录，右键git bash here，执行命令：<code>npm install hexo-generator-searchdb --save</code></p><p>修改根目录下的_config.yml，在最底部添加如下配置<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">search:</span></span><br><span class="line"><span class="symbol">path:</span> search.xml</span><br><span class="line"><span class="symbol">field:</span> post</span><br><span class="line"><span class="symbol">format:</span> html</span><br><span class="line"><span class="symbol">limit:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure></p><p>修改主体下的themes\next_config.yml配置文件（我的目录：blog\themes\next_config.yml）</p><p>搜索<strong>local_search</strong>，修改enable为true</p><p>预览效果，开启本地server</p><p><code>hexo clean</code>  (清除缓存文件 (db.json) 和已生成的静态文件 (public))<br><code>hexo g</code>（生成静态文件）<br><code>hexo s</code>（启动服务器）</p><p>按下 <code>Ctr+C</code> to stop</p><h2 id="部署到线上"><a href="#部署到线上" class="headerlink" title="部署到线上"></a>部署到线上</h2><p><code>hexo g</code><br><code>hexo d</code>    （部署到线上服务器）</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;以前都是在CSDN上写博客，就想着何时自己搭建一个博客，终于通过借鉴和看了很多大神的文章，开启了Hexo+Github搭建博客，这里跟大家分享一些心得。&lt;br&gt;
    
    </summary>
    
      <category term="Hexo" scheme="https://wshaobin.github.io/categories/Hexo/"/>
    
    
      <category term="Hexo" scheme="https://wshaobin.github.io/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>Android 蓝牙设备通讯的开发(配对/连接/传输数据)</title>
    <link href="https://wshaobin.github.io/2018/12/19/ble-2/"/>
    <id>https://wshaobin.github.io/2018/12/19/ble-2/</id>
    <published>2018-12-19T09:40:14.000Z</published>
    <updated>2019-10-24T06:13:05.992Z</updated>
    
    <content type="html"><![CDATA[<p>最近公司想做一个关于蓝牙的项目,同时我也学习到了很多关于蓝牙方面的很多知识点,希望在这里跟大家分享下,不足之处有望指明.</p><a id="more"></a><p>这里先附上项目图片,不过这里ListView中如果是已配对的就进行连接,如果是未配对的就进行配对,配对完成之后这里的话要重新搜索设备,这里没做刷新.还有就是可以在两只手机上都装上这个,再连接上就可以进行发送到另一只手机上去,不知道为什么有时候好像蓝牙有些不知是否不太稳定,出现搜索蓝牙有些没搜到.<br><img src="/images/article/ble_2_1.png" alt="在这里插入图片描述"></p><p>在很多方面，蓝牙是一种能够发送或接受两个不同的设备之间传输的数据。 Android平台包含了蓝牙框架，使设备以无线方式与其他蓝牙设备进行数据交换的支持。</p><p><a href="http://download.csdn.net/detail/qq_30552993/9529815" target="_blank" rel="noopener">项目源码</a></p><p>Android提供蓝牙API来执行这些不同的操作。</p><ol><li>扫描其他蓝牙设备</li><li>获取配对设备列表</li><li>连接到通过服务发现其他设备</li></ol><p>Android提供BluetoothAdapter类蓝牙通信，通过调用创建的对象的静态方法getDefaultAdapter。其语法如下:<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">private BluetoothAdapter mBA<span class="comment">;</span></span><br><span class="line"><span class="attribute">mBA</span> = BluetoothAdapter.getDefaultAdapter()<span class="comment">;</span></span><br></pre></td></tr></table></figure></p><p>这里我把一些关于蓝牙的打开/关闭/配对/连接/数据传输的线程都封装BlueToothUtils这个蓝牙工具类中</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.bluetooth.BluetoothAdapter;</span><br><span class="line"><span class="keyword">import</span> android.bluetooth.BluetoothDevice;</span><br><span class="line"><span class="keyword">import</span> android.bluetooth.BluetoothServerSocket;</span><br><span class="line"><span class="keyword">import</span> android.bluetooth.BluetoothSocket;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Handler;</span><br><span class="line"><span class="keyword">import</span> android.os.Message;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by shaolin on 5/23/16.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlueToothUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"BlueToothUtils"</span>;</span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> BlueToothUtils sInstance;</span><br><span class="line">    <span class="keyword">private</span> BluetoothAdapter mBA;</span><br><span class="line">    <span class="comment">// UUID.randomUUID()随机获取UUID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UUID MY_UUID = UUID</span><br><span class="line">            .fromString(<span class="string">"db764ac8-4b08-7f25-aafe-59d03c27bae3"</span>);</span><br><span class="line">    <span class="comment">// 连接对象的名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String NAME = <span class="string">"LGL"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里本身即是服务端也是客户端，需要如下类</span></span><br><span class="line">    <span class="keyword">private</span> BluetoothSocket mSocket;</span><br><span class="line">    <span class="keyword">private</span> BluetoothDevice mOldDevice;</span><br><span class="line">    <span class="keyword">private</span> BluetoothDevice mCurDevice;</span><br><span class="line">    <span class="comment">// 输出流_客户端需要往服务端输出</span></span><br><span class="line">    <span class="keyword">private</span> OutputStream os;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//线程类的实例</span></span><br><span class="line">    <span class="keyword">private</span> AcceptThread ac;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="function">BlueToothUtils <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sInstance = <span class="keyword">new</span> BlueToothUtils();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BlueToothUtils</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mBA = BluetoothAdapter.getDefaultAdapter();</span><br><span class="line">        ac = <span class="keyword">new</span> AcceptThread();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">setContext</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function">BluetoothAdapter <span class="title">getBA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mBA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function">AcceptThread <span class="title">getAc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ac;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function">BluetoothDevice <span class="title">getCurDevice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mCurDevice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否打开蓝牙</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mBA.isEnabled()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 搜索设备</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">searchDevices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 判断是否在搜索,如果在搜索，就取消搜索</span></span><br><span class="line">        <span class="keyword">if</span> (mBA.isDiscovering()) &#123;</span><br><span class="line">            mBA.cancelDiscovery();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 开始搜索</span></span><br><span class="line">        mBA.startDiscovery();</span><br><span class="line">        Log.e(TAG, <span class="string">"正在搜索..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取已经配对的设备</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;BluetoothDevice&gt; getBondedDevices() &#123;</span><br><span class="line">        List&lt;BluetoothDevice&gt; devices = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Set&lt;BluetoothDevice&gt; pairedDevices = mBA.getBondedDevices();</span><br><span class="line">        <span class="comment">// 判断是否有配对过的设备</span></span><br><span class="line">        <span class="keyword">if</span> (pairedDevices.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (BluetoothDevice device : pairedDevices) &#123;</span><br><span class="line">                devices.add(device);</span><br><span class="line">                Log.e(TAG, <span class="string">"BondedDevice:"</span> + device.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> devices;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 与设备配对</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> device</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">createBond</span><span class="params">(BluetoothDevice device)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method createBondMethod = BluetoothDevice.class.getMethod(<span class="string">"createBond"</span>);</span><br><span class="line">            createBondMethod.invoke(device);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 与设备解除配对</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> device</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">removeBond</span><span class="params">(BluetoothDevice device)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method removeBondMethod = device.getClass().getMethod(<span class="string">"removeBond"</span>);</span><br><span class="line">            removeBondMethod.invoke(device);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> device</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str  设置PIN码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">setPin</span><span class="params">(BluetoothDevice device, String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method removeBondMethod = device.getClass().getDeclaredMethod(<span class="string">"setPin"</span>,</span><br><span class="line">                    <span class="keyword">new</span> Class[]&#123;<span class="keyword">byte</span>[].class&#125;);</span><br><span class="line">            Boolean returnValue = (Boolean) removeBondMethod.invoke(device,</span><br><span class="line">                    <span class="keyword">new</span> Object[]&#123;str.getBytes()&#125;);</span><br><span class="line">            Log.e(<span class="string">"returnValue"</span>, <span class="string">""</span> + returnValue);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消用户输入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">cancelPairingUserInput</span><span class="params">(BluetoothDevice device)</span> </span>&#123;</span><br><span class="line">        Boolean returnValue = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method createBondMethod = device.getClass().getMethod(<span class="string">"cancelPairingUserInput"</span>);</span><br><span class="line">            returnValue = (Boolean) createBondMethod.invoke(device);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// cancelBondProcess()</span></span><br><span class="line">        <span class="function"><span class="keyword">return</span> returnValue.<span class="title">booleanValue</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消配对</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">cancelBondProcess</span><span class="params">(BluetoothDevice device)</span> </span>&#123;</span><br><span class="line">        Boolean returnValue = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method createBondMethod = device.getClass().getMethod(<span class="string">"cancelBondProcess"</span>);</span><br><span class="line">            returnValue = (Boolean) createBondMethod.invoke(device);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> returnValue.<span class="title">booleanValue</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> strAddr</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> strPsw</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">pair</span><span class="params">(String strAddr, String strPsw)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">        mBA.cancelDiscovery();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mBA.isEnabled()) &#123;</span><br><span class="line">            mBA.enable();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!BluetoothAdapter.checkBluetoothAddress(strAddr)) &#123; <span class="comment">// 检查蓝牙地址是否有效</span></span><br><span class="line">            Log.d(<span class="string">"mylog"</span>, <span class="string">"devAdd un effient!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        BluetoothDevice device = mBA.getRemoteDevice(strAddr);</span><br><span class="line">        <span class="keyword">if</span> (device.getBondState() != BluetoothDevice.BOND_BONDED) &#123;</span><br><span class="line">            Log.d(<span class="string">"mylog"</span>, <span class="string">"NOT BOND_BONDED"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                setPin(device, strPsw); <span class="comment">// 手机和蓝牙采集器配对</span></span><br><span class="line">                createBond(device);</span><br><span class="line">                result = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Log.d(<span class="string">"mylog"</span>, <span class="string">"setPiN failed!"</span>);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.d(<span class="string">"mylog"</span>, <span class="string">"HAS BOND_BONDED"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                createBond(device);</span><br><span class="line">                setPin(device, strPsw); <span class="comment">// 手机和蓝牙采集器配对</span></span><br><span class="line">                createBond(device);</span><br><span class="line">                result = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Log.d(<span class="string">"mylog"</span>, <span class="string">"setPiN failed!"</span>);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取device.getClass()这个类中的所有Method</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clsShow</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">printAllInform</span><span class="params">(Class clsShow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 取得所有方法</span></span><br><span class="line">            Method[] hideMethod = clsShow.getMethods();</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (; i &lt; hideMethod.length; i++) &#123;</span><br><span class="line">                Log.e(<span class="string">"method name"</span>, hideMethod[i].getName() + <span class="string">";and the i is:"</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 取得所有常量</span></span><br><span class="line">            Field[] allFields = clsShow.getFields();</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; allFields.length; i++) &#123;</span><br><span class="line">                Log.e(<span class="string">"Field name"</span>, allFields[i].getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打开蓝牙</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">openBlueTooth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!mBA.isEnabled()) &#123;</span><br><span class="line">            <span class="comment">// 弹出对话框提示用户是后打开</span></span><br><span class="line">            <span class="comment">/*Intent intent = new Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);</span></span><br><span class="line"><span class="comment">            startActivityForResult(intent, 1);*/</span></span><br><span class="line">            <span class="comment">// 不做提示，强行打开</span></span><br><span class="line">            mBA.enable();</span><br><span class="line">            showToast(<span class="string">"打开蓝牙"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            showToast(<span class="string">"蓝牙已打开"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭蓝牙</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">closeBlueTooth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mBA.disable();</span><br><span class="line">        showToast(<span class="string">"关闭蓝牙"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 弹出Toast窗口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">showToast</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Toast.makeText(mContext, message, Toast.LENGTH_LONG).show();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"message:"</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主动连接蓝牙</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> device</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">connectDevice</span><span class="params">(BluetoothDevice device)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 判断是否在搜索,如果在搜索，就取消搜索</span></span><br><span class="line">        <span class="keyword">if</span> (mBA.isDiscovering()) &#123;</span><br><span class="line">            mBA.cancelDiscovery();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获得远程设备</span></span><br><span class="line">            <span class="keyword">if</span> (mCurDevice == <span class="keyword">null</span> || mCurDevice != mOldDevice) &#123;</span><br><span class="line">                mCurDevice = mBA.getRemoteDevice(device.getAddress());</span><br><span class="line">                mOldDevice = mCurDevice;</span><br><span class="line">                Log.e(TAG, <span class="string">"device:"</span> + mCurDevice);</span><br><span class="line">                mSocket = mCurDevice.createRfcommSocketToServiceRecord(MY_UUID);</span><br><span class="line">                <span class="comment">// 连接</span></span><br><span class="line">                mSocket.connect();</span><br><span class="line">                <span class="comment">// 获得输出流</span></span><br><span class="line">                os = mSocket.getOutputStream();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果成功获得输出流</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 传输数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">write</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (os != <span class="keyword">null</span>) &#123;</span><br><span class="line">                os.write(message.getBytes(<span class="string">"GBK"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            Log.e(TAG, <span class="string">"write:"</span> + message);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务端，需要监听客户端的线程类</span></span><br><span class="line">    <span class="keyword">private</span> Handler <span class="keyword">handler</span> = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            showToast(String.valueOf(msg.obj));</span><br><span class="line">            Log.e(TAG, <span class="string">"服务端:"</span> + msg.obj);</span><br><span class="line">            <span class="keyword">super</span>.handleMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线程服务类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> BluetoothServerSocket serverSocket;</span><br><span class="line">        <span class="keyword">private</span> BluetoothSocket socket;</span><br><span class="line">        <span class="comment">// 输入 输出流</span></span><br><span class="line">        <span class="keyword">private</span> OutputStream os;</span><br><span class="line">        <span class="keyword">private</span> InputStream is;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AcceptThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                serverSocket = mBA.listenUsingRfcommWithServiceRecord(NAME, MY_UUID);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 截获客户端的蓝牙消息</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                socket = serverSocket.accept(); <span class="comment">// 如果阻塞了，就会一直停留在这里</span></span><br><span class="line">                is = socket.getInputStream();</span><br><span class="line">                os = socket.getOutputStream();</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                        <span class="keyword">byte</span>[] tt = <span class="keyword">new</span> <span class="keyword">byte</span>[is.available()];</span><br><span class="line">                        <span class="keyword">if</span> (tt.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            is.read(tt, <span class="number">0</span>, tt.length);</span><br><span class="line">                            Message msg = <span class="keyword">new</span> Message();</span><br><span class="line">                            msg.obj = <span class="keyword">new</span> String(tt, <span class="string">"GBK"</span>);</span><br><span class="line">                            Log.e(TAG, <span class="string">"客户端:"</span> + msg.obj);</span><br><span class="line">                            <span class="keyword">handler</span>.sendMessage(msg);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>参考:<a href="http://www.yiibai.com/android/android_bluetooth.html" target="_blank" rel="noopener">http://www.yiibai.com/android/android_bluetooth.html</a></p><p><a href="http://www.cnblogs.com/jason-star/archive/2012/09/10/2678368.html" target="_blank" rel="noopener">http://www.cnblogs.com/jason-star/archive/2012/09/10/2678368.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近公司想做一个关于蓝牙的项目,同时我也学习到了很多关于蓝牙方面的很多知识点,希望在这里跟大家分享下,不足之处有望指明.&lt;/p&gt;
    
    </summary>
    
      <category term="Android" scheme="https://wshaobin.github.io/categories/Android/"/>
    
    
      <category term="Android" scheme="https://wshaobin.github.io/tags/Android/"/>
    
      <category term="Ble" scheme="https://wshaobin.github.io/tags/Ble/"/>
    
  </entry>
  
  <entry>
    <title>Android BLE最完整的工具类(扫描/连接/读写/通知设备)</title>
    <link href="https://wshaobin.github.io/2018/12/19/ble-1/"/>
    <id>https://wshaobin.github.io/2018/12/19/ble-1/</id>
    <published>2018-12-19T09:30:19.000Z</published>
    <updated>2019-10-24T06:13:03.251Z</updated>
    
    <content type="html"><![CDATA[<p>这里只要是Android设备与BLE设备的通讯都可以共用，只需要该的就是uuid的值，还有就是ble设备提供商要出文档协议，看看是如何发命令跟接收命令的。<br><a id="more"></a></p><p>BleUtil工具中，有些地方我感觉还是要提示下</p><p>1、characterUUID1 、characterUUID2 、descriptorUUID 这三个是对应的收发命令的，跟找到要操作的BluetoothGattDescriptor（特性）。</p><p>在做这个项目的时候ble设备提供商给的文档中uuid，是短的，我实际我打印出来的是长的。其实短的那种是ios来的，而android就不一样咯。可以参考：<a href="http://blog.csdn.net/qq_30552993/article/details/51819331" target="_blank" rel="noopener">Android与IOS的UUID的区别</a></p><p>2、sendWorkModel、sendStrength 这两个方法是用来发送命令的，传值都是byte[]数组；而接收命令的话通过receiveData方法进行解析得到的byte[]。这三个方法都是需要根据不同设备协议进行修改，这里只是为了案例展示。总的来说就是收发命令都是byte[]</p><h2 id="关键概念"><a href="#关键概念" class="headerlink" title="关键概念"></a>关键概念</h2><h3 id="Generic-Attribute-Profile-GATT"><a href="#Generic-Attribute-Profile-GATT" class="headerlink" title="Generic Attribute Profile (GATT)"></a>Generic Attribute Profile (GATT)</h3><p>通过BLE连接，读写属性类小数据的Profile通用规范。现在所有的BLE应用Profile都是基于GATT的。</p><h3 id="Attribute-Protocol-ATT"><a href="#Attribute-Protocol-ATT" class="headerlink" title="Attribute Protocol (ATT)"></a>Attribute Protocol (ATT)</h3><p>GATT是基于ATT Protocol的。ATT针对BLE设备做了专门的优化，具体就是在传输过程中使用尽量少的数据。</p><p>每个属性都有一个唯一的UUID，属性将以characteristics and services的形式传输。</p><h3 id="Characteristic"><a href="#Characteristic" class="headerlink" title="Characteristic"></a>Characteristic</h3><p>Characteristic可以理解为一个数据类型，它包括一个value和0至多个对次value的描述（Descriptor）。</p><h3 id="Descriptor"><a href="#Descriptor" class="headerlink" title="Descriptor"></a>Descriptor</h3><p>对Characteristic的描述，例如范围、计量单位等。</p><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>Characteristic的集合。例如一个service叫做“Heart Rate Monitor”，</p><p>它可能包含多个Characteristics，其中可能包含一个叫做“heart rate measurement”的Characteristic。</p><h2 id="角色和职责"><a href="#角色和职责" class="headerlink" title="角色和职责"></a>角色和职责</h2><p>Android设备与BLE设备交互有两组角色：</p><p>中心设备和外围设备（Central vs. peripheral）；</p><p>GATT server vs. GATT client.</p><p>Central vs. peripheral:</p><p>中心设备和外围设备的概念针对的是BLE连接本身。</p><p>Central角色负责scan advertisement。而peripheral角色负责make advertisement。</p><p>GATT server vs. GATT client:</p><p>这两种角色取决于BLE连接成功后，两个设备间通信的方式。</p><p>举例说明：</p><p>现有一个活动追踪的BLE设备和一个支持BLE的Android设备。</p><p>Android设备支持Central角色，而BLE设备支持peripheral角色。</p><p>创建一个BLE连接需要这两个角色都存在，都仅支持Central角色或者都仅支持peripheral角色则无法建立连接。</p><p>当连接建立后，它们之间就需要传输GATT数据。</p><p>谁做server，谁做client，则取决于具体数据传输的情况。</p><p>例如，如果活动追踪的BLE设备需要向Android设备传输sensor数据，则活动追踪器自然成为了server端；</p><p>而如果活动追踪器需要从Android设备获取更新信息，则Android设备作为server端可能更合适。</p><h2 id="权限及feature"><a href="#权限及feature" class="headerlink" title="权限及feature"></a>权限及feature</h2><p>和经典蓝牙一样，应用使用蓝牙，需要声明BLUETOOTH权限，</p><p>如果需要扫描设备或者操作蓝牙设置，则还需要BLUETOOTH_ADMIN权限：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:<span class="attribute">name</span>=<span class="string">"android.permission.BLUETOOTH"</span>/&gt;</span><br><span class="line">&lt;uses-permission android:<span class="attribute">name</span>=<span class="string">"android.permission.BLUETOOTH_ADMIN"</span>/&gt;</span><br></pre></td></tr></table></figure><p>除了蓝牙权限外，如果需要BLE feature则还需要声明uses-feature：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-feature android:<span class="attribute">name</span>=<span class="string">"android.hardware.bluetooth_le"</span> android:<span class="attribute">required</span>=<span class="string">"true"</span>/&gt;</span><br></pre></td></tr></table></figure><p>按时required为true时，则应用只能在支持BLE的Android设备上安装运行；</p><p>required为false时，Android设备均可正常安装运行，需要在代码运行时判断设备是否支持BLE feature</p><h2 id="通讯设备的主要步骤"><a href="#通讯设备的主要步骤" class="headerlink" title="通讯设备的主要步骤"></a>通讯设备的主要步骤</h2><p>设置权限—&gt;打开蓝牙—&gt;扫描设备—&gt;连接设备—&gt;读写数据+通知设备的状态改变—&gt;断开设备</p><h2 id="BluetoothGatt的服务层次"><a href="#BluetoothGatt的服务层次" class="headerlink" title="BluetoothGatt的服务层次"></a>BluetoothGatt的服务层次</h2><p>BluetoothGatt—&gt;BluetoothGattService(服务)—&gt;BluetoothGattCharacteristic(特征)—&gt;BluetoothGattDescriptor(特性)</p><p>下面的就是重点啦!工具类,工具类,工具类好听的话说三遍<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.annotation.TargetApi;</span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.bluetooth.BluetoothAdapter;</span><br><span class="line"><span class="keyword">import</span> android.bluetooth.BluetoothDevice;</span><br><span class="line"><span class="keyword">import</span> android.bluetooth.BluetoothGatt;</span><br><span class="line"><span class="keyword">import</span> android.bluetooth.BluetoothGattCallback;</span><br><span class="line"><span class="keyword">import</span> android.bluetooth.BluetoothGattCharacteristic;</span><br><span class="line"><span class="keyword">import</span> android.bluetooth.BluetoothGattDescriptor;</span><br><span class="line"><span class="keyword">import</span> android.bluetooth.BluetoothGattService;</span><br><span class="line"><span class="keyword">import</span> android.bluetooth.BluetoothManager;</span><br><span class="line"><span class="keyword">import</span> android.bluetooth.BluetoothProfile;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.pm.PackageManager;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.os.Handler;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by shaolin on 6/17/16.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@TargetApi</span>(Build.VERSION_CODES.JELLY_BEAN_MR2)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BleUtil</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"BleUtil"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SCAN_PERIOD = <span class="number">10000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String characterUUID1 = <span class="string">"0000fff2-0000-1000-8000-00805f9b34fb"</span>;<span class="comment">//APP发送命令</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String characterUUID2 = <span class="string">"0000fff1-0000-1000-8000-00805f9b34fb"</span>;<span class="comment">//BLE用于回复命令</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String descriptorUUID = <span class="string">"00002902-0000-1000-8000-00805f9b34fb"</span>;<span class="comment">//BLE设备特性的UUID</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] workModel = &#123;<span class="number">0x02</span>, <span class="number">0x01</span>&#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BleUtil mInstance;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//作为中央来使用和处理数据；</span></span><br><span class="line">    <span class="keyword">private</span> BluetoothGatt mGatt;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> BluetoothManager manager;</span><br><span class="line">    <span class="keyword">private</span> BTUtilListener mListener;</span><br><span class="line">    <span class="keyword">private</span> BluetoothDevice mCurDevice;</span><br><span class="line">    <span class="keyword">private</span> BluetoothAdapter mBtAdapter;</span><br><span class="line">    <span class="keyword">private</span> List&lt;BluetoothDevice&gt; listDevice;</span><br><span class="line">    <span class="keyword">private</span> List&lt;BluetoothGattService&gt; serviceList;<span class="comment">//服务</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;BluetoothGattCharacteristic&gt; characterList;<span class="comment">//特征</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> BluetoothGattService service;</span><br><span class="line">    <span class="keyword">private</span> BluetoothGattCharacteristic character1;</span><br><span class="line">    <span class="keyword">private</span> BluetoothGattCharacteristic character2;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> BleUtil <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mInstance = <span class="keyword">new</span> BleUtil();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mInstance;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContext</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        listDevice = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (!mContext.getPackageManager().hasSystemFeature(PackageManager.FEATURE_BLUETOOTH_LE)) &#123;</span><br><span class="line">            showToast(<span class="string">"BLE不支持此设备!"</span>);</span><br><span class="line">            ((Activity) mContext).finish();</span><br><span class="line">        &#125;</span><br><span class="line">        manager = (BluetoothManager) mContext.getSystemService(Context.BLUETOOTH_SERVICE);</span><br><span class="line">        <span class="comment">//注：这里通过getSystemService获取BluetoothManager，</span></span><br><span class="line">        <span class="comment">//再通过BluetoothManager获取BluetoothAdapter。BluetoothManager在Android4.3以上支持(API level 18)。</span></span><br><span class="line">        <span class="keyword">if</span> (manager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mBtAdapter = manager.getAdapter();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mBtAdapter == <span class="keyword">null</span> || !mBtAdapter.isEnabled()) &#123;</span><br><span class="line">            mBtAdapter.enable();</span><br><span class="line">            <span class="comment">/*Intent enableBtIntent = new Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);</span></span><br><span class="line"><span class="comment">            mContext.startActivity(enableBtIntent);*/</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//扫描设备的回调</span></span><br><span class="line">    <span class="keyword">private</span> BluetoothAdapter.LeScanCallback mLeScanCallback = <span class="keyword">new</span> BluetoothAdapter.LeScanCallback() &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLeScan</span><span class="params">(<span class="keyword">final</span> BluetoothDevice device, <span class="keyword">int</span> rssi,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">byte</span>[] scanRecord)</span> </span>&#123;</span><br><span class="line">            ((Activity) mContext).runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (!listDevice.contains(device)) &#123;</span><br><span class="line">                        <span class="comment">//不重复添加</span></span><br><span class="line">                        listDevice.add(device);</span><br><span class="line">                        mListener.onLeScanDevices(listDevice);</span><br><span class="line">                        Log.e(TAG, <span class="string">"device:"</span> + device.toString());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//扫描设备</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanLeDevice</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> enable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (enable) &#123;</span><br><span class="line">            Handler mHandler = <span class="keyword">new</span> Handler();</span><br><span class="line">            mHandler.postDelayed(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    stopScan();</span><br><span class="line">                    Log.e(TAG, <span class="string">"run: stop"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, SCAN_PERIOD);</span><br><span class="line">            startScan();</span><br><span class="line">            Log.e(TAG, <span class="string">"start"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            stopScan();</span><br><span class="line">            Log.e(TAG, <span class="string">"stop"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//开始扫描BLE设备</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startScan</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mBtAdapter.startLeScan(mLeScanCallback);</span><br><span class="line">        mListener.onLeScanStart();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//停止扫描BLE设备</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopScan</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mBtAdapter.stopLeScan(mLeScanCallback);</span><br><span class="line">        mListener.onLeScanStop();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//返回中央的状态和周边提供的数据</span></span><br><span class="line">    <span class="keyword">private</span> BluetoothGattCallback mGattCallback = <span class="keyword">new</span> BluetoothGattCallback() &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConnectionStateChange</span><span class="params">(BluetoothGatt gatt, <span class="keyword">int</span> status,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">int</span> newState)</span> </span>&#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"onConnectionStateChange"</span>);</span><br><span class="line">            <span class="keyword">switch</span> (newState) &#123;</span><br><span class="line">                <span class="keyword">case</span> BluetoothProfile.STATE_CONNECTED:</span><br><span class="line">                    Log.e(TAG, <span class="string">"STATE_CONNECTED"</span>);</span><br><span class="line">                    mListener.onConnected(mCurDevice);</span><br><span class="line">                    gatt.discoverServices(); <span class="comment">//搜索连接设备所支持的service</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> BluetoothProfile.STATE_DISCONNECTED:</span><br><span class="line">                    mListener.onDisConnected(mCurDevice);</span><br><span class="line">                    disConnGatt();</span><br><span class="line">                    Log.e(TAG, <span class="string">"STATE_DISCONNECTED"</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> BluetoothProfile.STATE_CONNECTING:</span><br><span class="line">                    mListener.onConnecting(mCurDevice);</span><br><span class="line">                    Log.e(TAG, <span class="string">"STATE_CONNECTING"</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> BluetoothProfile.STATE_DISCONNECTING:</span><br><span class="line">                    mListener.onDisConnecting(mCurDevice);</span><br><span class="line">                    Log.e(TAG, <span class="string">"STATE_DISCONNECTING"</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">super</span>.onConnectionStateChange(gatt, status, newState);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServicesDiscovered</span><span class="params">(BluetoothGatt gatt, <span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"onServicesDiscovered"</span>);</span><br><span class="line">            <span class="keyword">if</span> (status == BluetoothGatt.GATT_SUCCESS) &#123;</span><br><span class="line">                serviceList = gatt.getServices();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; serviceList.size(); i++) &#123;</span><br><span class="line">                    BluetoothGattService theService = serviceList.get(i);</span><br><span class="line"> </span><br><span class="line">                    Log.e(TAG, <span class="string">"ServiceName:"</span> + theService.getUuid());</span><br><span class="line">                    characterList = theService.getCharacteristics();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; characterList.size(); j++) &#123;</span><br><span class="line">                        String uuid = characterList.get(j).getUuid().toString();</span><br><span class="line">                        Log.e(TAG, <span class="string">"---CharacterName:"</span> + uuid);</span><br><span class="line">                        <span class="keyword">if</span> (uuid.equals(characterUUID1)) &#123;</span><br><span class="line">                            character1 = characterList.get(j);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uuid.equals(characterUUID2)) &#123;</span><br><span class="line">                            character2 = characterList.get(j);</span><br><span class="line">                            setNotification();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">super</span>.onServicesDiscovered(gatt, status);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCharacteristicRead</span><span class="params">(BluetoothGatt gatt, BluetoothGattCharacteristic characteristic, <span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"onCharacteristicRead"</span>);</span><br><span class="line">            <span class="keyword">super</span>.onCharacteristicRead(gatt, characteristic, status);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCharacteristicWrite</span><span class="params">(BluetoothGatt gatt, BluetoothGattCharacteristic characteristic, <span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"onCharacteristicWrite"</span>);</span><br><span class="line">            <span class="keyword">super</span>.onCharacteristicWrite(gatt, characteristic, status);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCharacteristicChanged</span><span class="params">(BluetoothGatt gatt, BluetoothGattCharacteristic characteristic)</span> </span>&#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"onCharacteristicChanged"</span>);</span><br><span class="line"><span class="comment">//            这里是可以监听到设备自身或者手机改变设备的一些数据修改h通知</span></span><br><span class="line">            receiveData(characteristic);</span><br><span class="line">            <span class="keyword">super</span>.onCharacteristicChanged(gatt, characteristic);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//获取设备指定的特征中的特性,其中对其进行监听, setCharacteristicNotification与上面的回调onCharacteristicChanged进行一一搭配</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setNotification</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mGatt.setCharacteristicNotification(character2, <span class="keyword">true</span>);</span><br><span class="line">        BluetoothGattDescriptor descriptor = character2.getDescriptor(UUID.fromString(descriptorUUID));</span><br><span class="line">        descriptor.setValue(BluetoothGattDescriptor.ENABLE_NOTIFICATION_VALUE);</span><br><span class="line">        mGatt.writeDescriptor(descriptor);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//接收数据,对其进行处理</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">receiveData</span><span class="params">(BluetoothGattCharacteristic ch)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = ch.getValue();</span><br><span class="line">        <span class="keyword">int</span> cmd = bytes[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">int</span> agree = bytes[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                mListener.onStrength(agree);</span><br><span class="line">                Log.e(TAG, <span class="string">"手机通知BLE设备强度:"</span> + agree);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                mListener.onModel(agree);</span><br><span class="line">                Log.e(TAG, <span class="string">"工作模式:"</span> + agree);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                mListener.onStrength(agree);</span><br><span class="line">                Log.e(TAG, <span class="string">"设备自身通知改变强度:"</span> + agree);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//连接设备</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectLeDevice</span><span class="params">(<span class="keyword">int</span> devicePos)</span> </span>&#123;</span><br><span class="line">        mBtAdapter.stopLeScan(mLeScanCallback);</span><br><span class="line">        mCurDevice = listDevice.get(devicePos);</span><br><span class="line">        checkConnGatt();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//发送进入工作模式请求</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendWorkModel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (character1 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            character1.setValue(workModel);</span><br><span class="line">            mGatt.writeCharacteristic(character1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//发送强度</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendStrength</span><span class="params">(<span class="keyword">int</span> strength)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] strengthModel = &#123;<span class="number">0x01</span>, (<span class="keyword">byte</span>) strength&#125;;</span><br><span class="line">        <span class="keyword">if</span> (character1 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            character1.setValue(strengthModel);</span><br><span class="line">            mGatt.writeCharacteristic(character1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//检查设备是否连接了</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkConnGatt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mGatt == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mGatt = mCurDevice.connectGatt(mContext, <span class="keyword">true</span>, mGattCallback);</span><br><span class="line">            mListener.onConnecting(mCurDevice);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mGatt.connect();</span><br><span class="line">            mGatt.discoverServices();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//  断开设备连接</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">disConnGatt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mGatt != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mGatt.disconnect();</span><br><span class="line">            mGatt.close();</span><br><span class="line">            mGatt = <span class="keyword">null</span>;</span><br><span class="line">            listDevice = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            mListener.onLeScanDevices(listDevice);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showToast</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(mContext, message, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBTUtilListener</span><span class="params">(BTUtilListener listener)</span> </span>&#123;</span><br><span class="line">        mListener = listener;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BTUtilListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onLeScanStart</span><span class="params">()</span></span>; <span class="comment">// 扫描开始</span></span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onLeScanStop</span><span class="params">()</span></span>;  <span class="comment">// 扫描停止</span></span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onLeScanDevices</span><span class="params">(List&lt;BluetoothDevice&gt; listDevice)</span></span>; <span class="comment">//扫描得到的设备</span></span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onConnected</span><span class="params">(BluetoothDevice mCurDevice)</span></span>; <span class="comment">//设备的连接</span></span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onDisConnected</span><span class="params">(BluetoothDevice mCurDevice)</span></span>; <span class="comment">//设备断开连接</span></span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onConnecting</span><span class="params">(BluetoothDevice mCurDevice)</span></span>; <span class="comment">//设备连接中</span></span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onDisConnecting</span><span class="params">(BluetoothDevice mCurDevice)</span></span>; <span class="comment">//设备连接失败</span></span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onStrength</span><span class="params">(<span class="keyword">int</span> strength)</span></span>; <span class="comment">//给设备设置强度</span></span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onModel</span><span class="params">(<span class="keyword">int</span> model)</span></span>; <span class="comment">//设备模式</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>参考:<a href="http://www.myext.cn/android/a_4699.html" target="_blank" rel="noopener">http://www.myext.cn/android/a_4699.html</a></p><p>重点:<a href="http://blog.csdn.net/qq_30552993/article/details/51819331" target="_blank" rel="noopener">Android与IOS的UUID的区别</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这里只要是Android设备与BLE设备的通讯都可以共用，只需要该的就是uuid的值，还有就是ble设备提供商要出文档协议，看看是如何发命令跟接收命令的。&lt;br&gt;
    
    </summary>
    
      <category term="Android" scheme="https://wshaobin.github.io/categories/Android/"/>
    
    
      <category term="Android" scheme="https://wshaobin.github.io/tags/Android/"/>
    
      <category term="Ble" scheme="https://wshaobin.github.io/tags/Ble/"/>
    
  </entry>
  
  <entry>
    <title>Android 腾讯Bugly的应用升级&amp;热更新</title>
    <link href="https://wshaobin.github.io/2018/12/19/bugly-upgrade-update/"/>
    <id>https://wshaobin.github.io/2018/12/19/bugly-upgrade-update/</id>
    <published>2018-12-19T08:49:09.000Z</published>
    <updated>2019-10-24T06:13:11.155Z</updated>
    
    <content type="html"><![CDATA[<p>经过去年的九月份至现在，发现自己很久没有写过比较好的文章了。今天就趁着通宵的劲，写一下对腾讯Bugly的应用升级&amp;热更新的理解，希望对新手有所帮助，有兴趣的可以了解下，没兴趣的也可以看完之后吐槽我。。。</p><a id="more"></a><p>Bugly 文档中心：<a href="https://bugly.qq.com/docs/" target="_blank" rel="noopener">https://bugly.qq.com/docs/</a></p><p>官方文档写的还是蛮详细的，不过有些地方还是自己绕了很多弯，请教了公司大神才弄清楚的。</p><p>本篇文章已授权 玩Android 独家发布</p><p>项目配置的话，本人选择直接配置应用升级&amp;热更新。</p><h2 id="配置gradle"><a href="#配置gradle" class="headerlink" title="配置gradle"></a>配置gradle</h2><h3 id="project-build-gradle"><a href="#project-build-gradle" class="headerlink" title="project: build.gradle"></a>project: build.gradle</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">'com.android.tools.build:gradle:3.1.3'</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// tinkersupport插件, 其中lastest.release指拉取最新版本，也可以指定明确版本号，例如1.0.4</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">"com.tencent.bugly:tinker-support:1.1.1"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">task</span> clean(type: <span class="keyword">Delete</span>) &#123;</span><br><span class="line">    <span class="keyword">delete</span> rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="module-build-gradle"><a href="#module-build-gradle" class="headerlink" title="module: build.gradle"></a>module: build.gradle</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'com.android.application'</span></span><br><span class="line"><span class="comment">// 热更新依赖插件脚本，如果不想要热更新可以注释掉</span></span><br><span class="line">apply <span class="keyword">from</span>: <span class="string">'tinker-support.gradle'</span></span><br><span class="line"><span class="comment">//全局配置</span></span><br><span class="line">apply <span class="keyword">from</span>: <span class="string">"../config.gradle"</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion compile_sdk_version</span><br><span class="line">    buildToolsVersion build_tools_version</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">"com.example.administrator.myapplication"</span></span><br><span class="line">        minSdkVersion min_sdk_version</span><br><span class="line">        targetSdkVersion target_sdk_version</span><br><span class="line">        versionCode version_code</span><br><span class="line">        versionName version_name</span><br><span class="line">        testInstrumentationRunner <span class="string">"android.support.test.runner.AndroidJUnitRunner"</span></span><br><span class="line">        multiDexEnabled <span class="keyword">true</span></span><br><span class="line">        multiDexKeepProguard <span class="keyword">file</span>(<span class="string">'multiDexKeep.pro'</span>)</span><br><span class="line">        ndk &#123;</span><br><span class="line">            <span class="comment">// 设置支持的SO库架构</span></span><br><span class="line">            abiFilters <span class="string">'armeabi'</span>, <span class="string">'x86'</span>, <span class="string">'armeabi-v7a'</span>, <span class="string">'arm64-v8a'</span> <span class="comment">//, 'x86_64'</span></span><br><span class="line">        &#125;</span><br><span class="line">        javaCompileOptions &#123;</span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line">                includeCompileClasspath <span class="keyword">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    signingConfigs &#123;</span><br><span class="line">        debug &#123;</span><br><span class="line">            keyAlias <span class="string">'debug'</span></span><br><span class="line">            keyPassword <span class="string">'123456'</span></span><br><span class="line">            storeFile <span class="keyword">file</span>(<span class="string">'../debug.jks'</span>)</span><br><span class="line">            storePassword <span class="string">'123456'</span></span><br><span class="line">            v1SigningEnabled <span class="keyword">true</span></span><br><span class="line">            v2SigningEnabled <span class="keyword">false</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        release &#123;</span><br><span class="line">            v1SigningEnabled <span class="keyword">true</span></span><br><span class="line">            v2SigningEnabled <span class="keyword">false</span></span><br><span class="line">            keyAlias <span class="string">'key0'</span></span><br><span class="line">            keyPassword <span class="string">'123456'</span></span><br><span class="line">            storeFile <span class="keyword">file</span>(<span class="string">'../release.jks'</span>)</span><br><span class="line">            storePassword <span class="string">'123456'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            debuggable log_debug</span><br><span class="line">            shrinkResources <span class="keyword">false</span></span><br><span class="line">            minifyEnabled <span class="keyword">false</span></span><br><span class="line">            zipAlignEnabled <span class="keyword">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">            signingConfig signingConfigs.release</span><br><span class="line">            buildConfigField(<span class="string">"boolean"</span>, <span class="string">"LOG_DEBUG"</span>, String.valueOf(log_debug))</span><br><span class="line">        &#125;</span><br><span class="line">        debug &#123;</span><br><span class="line">            debuggable <span class="keyword">true</span></span><br><span class="line">            jniDebuggable <span class="keyword">true</span></span><br><span class="line">            signingConfig signingConfigs.debug</span><br><span class="line">            minifyEnabled <span class="keyword">false</span></span><br><span class="line">            zipAlignEnabled <span class="keyword">false</span></span><br><span class="line">            buildConfigField(<span class="string">"boolean"</span>, <span class="string">"LOG_DEBUG"</span>, String.valueOf(log_debug))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dexOptions &#123;</span><br><span class="line"><span class="comment">//        incremental true</span></span><br><span class="line"><span class="comment">//        maxProcessCount 2</span></span><br><span class="line">        javaMaxHeapSize <span class="string">"4g"</span></span><br><span class="line">        jumboMode = <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lintOptions &#123;</span><br><span class="line">        checkReleaseBuilds <span class="keyword">false</span></span><br><span class="line">        abortOnError <span class="keyword">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sourceSets</span> &#123;</span><br><span class="line">        main &#123;</span><br><span class="line">            jniLibs.srcDirs = [<span class="string">'libs'</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        <span class="keyword">flatDir</span> &#123;</span><br><span class="line">            dirs <span class="string">'libs'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support.constraint:constraint-layout:1.1.2'</span></span><br><span class="line">    testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">    androidTestCompile <span class="string">'com.android.support.test:runner:1.0.2'</span></span><br><span class="line">    androidTestCompile <span class="string">"com.android.support:support-annotations:$support_library_version"</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">"com.android.support:appcompat-v7:$support_library_version"</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">"com.android.support:support-v4:$support_library_version"</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">"com.android.support:multidex:1.0.3"</span> <span class="comment">// 多dex配置</span></span><br><span class="line">    <span class="comment">//------------------Bugly---------------------------------------------------------</span></span><br><span class="line">    <span class="comment">//    compile 'com.tencent.bugly:crashreport_upgrade:latest.release'</span></span><br><span class="line">    <span class="comment">//    compile 'com.tencent.bugly:nativecrashreport:latest.release'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.tencent.bugly:crashreport_upgrade:1.3.4'</span></span><br><span class="line">    <span class="comment">//升级SDK已经集成crash上报功能</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.tencent.bugly:nativecrashreport:3.3.1'</span></span><br><span class="line">    <span class="comment">//------------------Bugly---------------------------------------------------------</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="tinker-support-gradle"><a href="#tinker-support-gradle" class="headerlink" title="tinker-support.gradle"></a>tinker-support.gradle</h3><p>注：您需要在同级目录下创建tinker-support.gradle热更新配置文件<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: 'com.tencent.bugly.tinker-support'</span><br><span class="line"></span><br><span class="line">def <span class="attr">bakPath</span> = file(<span class="string">"<span class="subst">$&#123;buildDir&#125;</span>/bakApk/"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 此处填写每次构建生成的基准包目录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">def <span class="attr">baseApkDir</span> = <span class="string">"app-0710-15-48-49"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对于插件各参数的详细解析请参考</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">tinkerSupport &#123;</span><br><span class="line"></span><br><span class="line">    // 开启tinker-support插件，默认值<span class="literal">true</span></span><br><span class="line">    <span class="attr">enable</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    // 指定归档目录，默认值当前module的子目录tinker</span><br><span class="line">    <span class="attr">autoBackupApkDir</span> = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    // 是否启用覆盖tinkerPatch配置功能，默认值<span class="literal">false</span></span><br><span class="line">    // 开启后tinkerPatch配置不生效，即无需添加tinkerPatch</span><br><span class="line">    <span class="attr">overrideTinkerPatchConfiguration</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    // 编译补丁包时，必需指定基线版本的apk，默认值为空</span><br><span class="line">    // 如果为空，则表示不是进行补丁包的编译</span><br><span class="line">    // @&#123;link tinkerPatch.oldApk &#125;</span><br><span class="line">    <span class="attr">baseApk</span> = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/<span class="subst">$&#123;baseApkDir&#125;</span>/app-release.apk"</span></span><br><span class="line">//    <span class="attr">baseApk</span> = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/<span class="subst">$&#123;baseApkDir&#125;</span>/app-debug.apk"</span></span><br><span class="line"></span><br><span class="line">    // 对应tinker插件applyMapping</span><br><span class="line">    <span class="attr">baseApkProguardMapping</span> = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/<span class="subst">$&#123;baseApkDir&#125;</span>/app-release-mapping.txt"</span></span><br><span class="line">//    <span class="attr">baseApkProguardMapping</span> = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/<span class="subst">$&#123;baseApkDir&#125;</span>/app-debug-mapping.txt"</span></span><br><span class="line"></span><br><span class="line">    // 对应tinker插件applyResourceMapping</span><br><span class="line">    <span class="attr">baseApkResourceMapping</span> = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/<span class="subst">$&#123;baseApkDir&#125;</span>/app-release-R.txt"</span></span><br><span class="line">    //  <span class="attr">baseApkResourceMapping</span> = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/<span class="subst">$&#123;baseApkDir&#125;</span>/app-debug-R.txt"</span></span><br><span class="line"></span><br><span class="line">    // 构建基准包和补丁包都要指定不同的tinkerId，并且必须保证唯一性</span><br><span class="line">    // **基准包这里最好是改成base-versionname,patch包就改成patch-versionname,每个版本的都不一样**</span><br><span class="line">    <span class="attr">tinkerId</span> = <span class="string">"patch-1.0.1"</span></span><br><span class="line"></span><br><span class="line">    // 构建多渠道补丁时使用</span><br><span class="line">    // <span class="attr">buildAllFlavorsDir</span> = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/<span class="subst">$&#123;baseApkDir&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    // 是否启用加固模式，默认为<span class="literal">false</span>.(tinker-spport <span class="number">1.0</span>.<span class="number">7</span>起支持）</span><br><span class="line">    //tinker <span class="number">1.7</span>.<span class="number">8</span>版本及以上版本</span><br><span class="line">//    <span class="attr">isProtectedApp</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    // 是否开启反射Application模式</span><br><span class="line">    <span class="attr">enableProxyApplication</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一般来说,我们无需对下面的参数做任何的修改</span></span><br><span class="line"><span class="comment"> * 对于各参数的详细介绍请参考:</span></span><br><span class="line"><span class="comment"> * https://github.com/Tencent/tinker/wiki/Tinker-%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">tinkerPatch &#123;</span><br><span class="line">    //<span class="attr">oldApk</span> =<span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/<span class="subst">$&#123;appName&#125;</span>/app-release.apk"</span></span><br><span class="line">    <span class="attr">ignoreWarning</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">useSign</span> = <span class="literal">true</span></span><br><span class="line">    dex &#123;</span><br><span class="line">        <span class="attr">dexMode</span> = <span class="string">"jar"</span></span><br><span class="line">        <span class="attr">pattern</span> = [<span class="string">"classes*.dex"</span>]</span><br><span class="line">        <span class="attr">loader</span> = []</span><br><span class="line">    &#125;</span><br><span class="line">    lib &#123;</span><br><span class="line">        <span class="attr">pattern</span> = [<span class="string">"lib/*/*.so"</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res &#123;</span><br><span class="line">        <span class="attr">pattern</span> = [<span class="string">"res/*"</span>, <span class="string">"r/*"</span>, <span class="string">"assets/*"</span>, <span class="string">"resources.arsc"</span>, <span class="string">"AndroidManifest.xml"</span>]</span><br><span class="line">        <span class="attr">ignoreChange</span> = []</span><br><span class="line">        <span class="attr">largeModSize</span> = <span class="number">100</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    packageConfig &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    sevenZip &#123;</span><br><span class="line">        <span class="attr">zipArtifact</span> = <span class="string">"com.tencent.mm:SevenZip:1.1.10"</span></span><br><span class="line">//        <span class="attr">path</span> = <span class="string">"/usr/local/bin/7za"</span></span><br><span class="line">    &#125;</span><br><span class="line">    buildConfig &#123;</span><br><span class="line">        <span class="attr">keepDexApply</span> = <span class="literal">false</span></span><br><span class="line">        //<span class="attr">tinkerId</span> = <span class="string">"1.0.1-base"</span></span><br><span class="line">        //<span class="attr">applyMapping</span> = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/<span class="subst">$&#123;appName&#125;</span>/app-release-mapping.txt"</span> //  可选，设置mapping文件，建议保持旧apk的proguard混淆方式</span><br><span class="line">        //<span class="attr">applyResourceMapping</span> = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/<span class="subst">$&#123;appName&#125;</span>/app-release-R.txt"</span> // 可选，设置R.txt文件，通过旧apk文件保持ResId的分配</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>基准包一般都是以app-release.apk正式版，如果想要用debug版的话，上面的baseApk、baseApkProguardMapping、baseApkResourceMapping切换下。</p><h3 id="全局配置-config-gradle"><a href="#全局配置-config-gradle" class="headerlink" title="全局配置: config.gradle"></a>全局配置: config.gradle</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ext<span class="selector-class">.target_sdk_version</span> = <span class="number">27</span></span><br><span class="line">ext<span class="selector-class">.min_sdk_version</span> = <span class="number">19</span></span><br><span class="line">ext<span class="selector-class">.compile_sdk_version</span> = <span class="number">27</span></span><br><span class="line">ext<span class="selector-class">.build_tools_version</span> = <span class="string">'27.0.3'</span></span><br><span class="line">ext<span class="selector-class">.support_library_version</span> = <span class="string">'27.1.1'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//TODO 调试模式的开启关闭</span></span><br><span class="line">ext<span class="selector-class">.log_debug</span> = false</span><br><span class="line">ext<span class="selector-class">.version_code</span> = <span class="number">1</span></span><br><span class="line">ext<span class="selector-class">.version_name</span> = <span class="string">"1.0.1"</span></span><br></pre></td></tr></table></figure><h2 id="配置multiDexKeep"><a href="#配置multiDexKeep" class="headerlink" title="配置multiDexKeep"></a>配置multiDexKeep</h2><p><strong>Bugly MultiDex注意事项，把Bugly的类放到主Dex,即写在multiDexKeep.pro</strong></p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">tencent</span>.<span class="title">bugly</span>.** &#123;*;</span>&#125;</span></span><br><span class="line"><span class="ruby">-keep <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">administrator</span>.<span class="title">myapplication</span>.<span class="title">AppLike</span>&#123;*;</span>&#125;</span></span><br></pre></td></tr></table></figure><p>这里你的AppLike放在那里，对应修改其路径</p><p>附上项目目录结构图，在说明相对应的配置<br><img src="/images/article/bugly_1.png" alt="在这里插入图片描述"><br><img src="/images/article/bugly_2.png" alt="在这里插入图片描述"></p><h2 id="配置XML"><a href="#配置XML" class="headerlink" title="配置XML"></a>配置XML</h2><h3 id="权限、activity、provider"><a href="#权限、activity、provider" class="headerlink" title="权限、activity、provider"></a>权限、activity、provider</h3><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span></span><br><span class="line"><span class="xml">    xmlns:tools="http://schemas.android.com/tools"</span></span><br><span class="line"><span class="xml">    package="com.example.administrator.myapplication"&gt;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.READ_PHONE_STATE"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_WIFI_STATE"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.READ_LOGS"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> /&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">application</span></span></span></span><br><span class="line"><span class="xml">        android:name=".App"</span></span><br><span class="line"><span class="xml">        android:allowBackup="true"</span></span><br><span class="line"><span class="xml">        android:icon="@mipmap/ic_launcher"</span></span><br><span class="line"><span class="xml">        android:label="@string/app_name"</span></span><br><span class="line"><span class="xml">        android:roundIcon="@mipmap/ic_launcher_round"</span></span><br><span class="line"><span class="xml">        android:supportsRtl="true"</span></span><br><span class="line"><span class="xml">        android:theme="@style/AppTheme"&gt;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".MainActivity"</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- Bugly --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">activity</span></span></span></span><br><span class="line"><span class="xml">            android:name="com.tencent.bugly.beta.ui.BetaActivity"</span></span><br><span class="line"><span class="xml">            android:configChanges="keyboardHidden|orientation|screenSize|locale"</span></span><br><span class="line"><span class="xml">            android:theme="@android:style/Theme.Translucent" /&gt;</span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- Bugly --&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 用于兼容7.0以上设备 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">provider</span></span></span></span><br><span class="line"><span class="xml">            android:name=".MyFileProvider"</span></span><br><span class="line"><span class="xml">            android:authorities="$</span><span class="template-variable">&#123;applicationId&#125;</span><span class="xml">.fileProvider"</span></span><br><span class="line"><span class="xml">            android:exported="false"</span></span><br><span class="line"><span class="xml">            android:grantUriPermissions="true"</span></span><br><span class="line"><span class="xml">            tools:replace="name,authorities,exported,grantUriPermissions"&gt;</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">meta-data</span></span></span></span><br><span class="line"><span class="xml">                android:name="android.support.FILE_PROVIDER_PATHS"</span></span><br><span class="line"><span class="xml">                android:resource="@xml/provider_paths"</span></span><br><span class="line"><span class="xml">                tools:replace="name,resource" /&gt;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h3 id="provider-paths-xml"><a href="#provider-paths-xml" class="headerlink" title="provider_paths.xml"></a>provider_paths.xml</h3><p>在res目录新建xml文件夹，创建provider_paths.xml文件如下：</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">paths</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!--Bugly:这里配置的两个外部存储路径是升级SDK下载的文件可能存在的路径，一定要按照上面格式配置，不然可能会出现错误。--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- /storage/emulated/0/Download/$</span></span><span class="template-variable">&#123;applicationId&#125;</span><span class="xml"><span class="comment">/.beta/apk--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">external-path</span></span></span></span><br><span class="line"><span class="xml">        name="beta_external_path"</span></span><br><span class="line"><span class="xml">        path="Download/" /&gt;</span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!--/storage/emulated/0/Android/data/$</span></span><span class="template-variable">&#123;applicationId&#125;</span><span class="xml"><span class="comment">/files/apk/--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">external-path</span></span></span></span><br><span class="line"><span class="xml">        name="beta_external_files_path"</span></span><br><span class="line"><span class="xml">        path="Android/data/" /&gt;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">root-path</span></span></span></span><br><span class="line"><span class="xml">        name="root"</span></span><br><span class="line"><span class="xml">        path="root/" /&gt;</span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!--代表设备的根目录new File("/");--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">files-path</span></span></span></span><br><span class="line"><span class="xml">        name="my_image"</span></span><br><span class="line"><span class="xml">        path="images/" /&gt;</span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!--代表context.getFilesDir()--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cache-path</span></span></span></span><br><span class="line"><span class="xml">        name="cache"</span></span><br><span class="line"><span class="xml">        path="caches/" /&gt;</span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!--代表context.getCacheDir()--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">external-path</span></span></span></span><br><span class="line"><span class="xml">        name="my_dir"</span></span><br><span class="line"><span class="xml">        path="dirs/" /&gt;</span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!--代表Environment.getExternalStorageDirectory()--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!--&lt;external-files-path/&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!--代表context.getExternalFilesDirs()--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!--&lt;external-cache-path/&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!--代表getExternalCacheDirs()--&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h2 id="代码模块"><a href="#代码模块" class="headerlink" title="代码模块"></a>代码模块</h2><h3 id="App-java"><a href="#App-java" class="headerlink" title="App.java"></a>App.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">TinkerApplication</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> App mInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">App</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//同样修改成自己AppLike的路径</span></span><br><span class="line">        <span class="keyword">super</span>(ShareConstants.TINKER_ENABLE_ALL, <span class="string">"com.example.administrator.myapplication.AppLike"</span>,</span><br><span class="line">                <span class="string">"com.tencent.tinker.loader.TinkerLoader"</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> App <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        mInstance = <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AppLike-java"><a href="#AppLike-java" class="headerlink" title="AppLike.java"></a>AppLike.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppLike</span> <span class="keyword">extends</span> <span class="title">DefaultApplicationLike</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"Tinker.AppLike"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppLike</span><span class="params">(Application application, <span class="keyword">int</span> tinkerFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">boolean</span> tinkerLoadVerifyFlag, <span class="keyword">long</span> applicationStartElapsedTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">long</span> applicationStartMillisTime, Intent tinkerResultIntent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(application, tinkerFlags, tinkerLoadVerifyFlag, applicationStartElapsedTime, applicationStartMillisTime, tinkerResultIntent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        <span class="comment">//设置自定义升级对话框UI布局</span></span><br><span class="line">        Beta.upgradeDialogLayoutId = R.layout.upgrade_dialog;</span><br><span class="line">        <span class="comment">//添加可显示弹窗的Activity</span></span><br><span class="line">        Beta.canShowUpgradeActs.add(MainActivity.class);</span><br><span class="line">        <span class="comment">//TODO 初始化,AppID替换成平台上项目中产品信息的AppID</span></span><br><span class="line">Bugly.init(getApplication(), <span class="string">"AppID"</span>, BuildConfig.LOG_DEBUG);</span><br><span class="line">        <span class="comment">//  Q：你们是怎么定义开发设备的？</span></span><br><span class="line">        <span class="comment">//  BitmapQrCodeDecoder：我们会提供接口Bugly.setIsDevelopmentDevice(getApplicationContext(), true);，</span></span><br><span class="line">        <span class="comment">//  我们后台就会将你当前设备识别为开发设备，如果设置为false则非开发设备，我们会根据这个配置进行策略控制。</span></span><br><span class="line">        Bugly.setIsDevelopmentDevice(getApplication(), BuildConfig.LOG_DEBUG);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.ICE_CREAM_SANDWICH)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBaseContextAttached</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onBaseContextAttached(base);</span><br><span class="line">        MultiDex.install(base);</span><br><span class="line">        <span class="comment">// 安装tinker</span></span><br><span class="line">        <span class="comment">// TinkerManager.installTinker(this); 替换成下面Bugly提供的方法</span></span><br><span class="line">        Beta.installTinker(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.ICE_CREAM_SANDWICH)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerActivityLifecycleCallback</span><span class="params">(Application.ActivityLifecycleCallbacks callbacks)</span> </span>&#123;</span><br><span class="line">        getApplication().registerActivityLifecycleCallbacks(callbacks);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MyFileProvider-java"><a href="#MyFileProvider-java" class="headerlink" title="MyFileProvider.java"></a>MyFileProvider.java</h3><p>这里要注意一下，AndroidManifest.xml中的FileProvider类是在support-v4包中的，检查你的工程是否引入该类库，项目中新建一个MyFileProvider.java</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyFileProvider</span> <span class="keyword">extends</span> <span class="title">FileProvider</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="打包及发布的流程"><a href="#打包及发布的流程" class="headerlink" title="打包及发布的流程"></a>打包及发布的流程</h2><p>1、如果你还不知道怎么打包的话，可以看下图。如果知道的话可以看下如何打补丁包，双击一下等待数秒就打包好了。</p><p><img src="/images/article/bugly_3.png" alt="在这里插入图片描述"></p><p>2、打完包的apk跟补丁包文件目录<br><img src="/images/article/bugly_4.png" alt="在这里插入图片描述"></p><p>bakApk中app-xxx目录下的apk为基准包（可以用于官网中全量更新：发布新版本）<br>patch目录下的patch_signed_7zip.apk为补丁包（可以用于官网热更新：发布新补丁）</p><p>3、打包需要修改配置如下</p><ul><li>config.gradle</li></ul><blockquote><p>ext.log_debug = false<br>ext.version_code = 1<br>ext.version_name = “1.0.1”</p></blockquote><ul><li>tinker-support.gradle</li></ul><blockquote><p>def baseApkDir = “app-0710-18-39-06”<br>tinkerId = “patch-1.0.1”</p></blockquote><p><strong>项目版本打包，首先要确定如下配置</strong></p><blockquote><p>ext.log_debug = false  //调试模式的开启关闭，正式包要改成false<br>ext.version_code = 1<br>ext.version_name = “1.0.1”<br>tinkerId = “patch-1.0.1” // tinkerId=patch-version_name</p></blockquote><p>点击上图中的assembleRelease进行打正式包，生成app-0710-18-39-06下的app-release.apk(<em>这个就是正式包，也算是基准包</em>)，然后把apk上传到bugly，如下图</p><p><img src="/images/article/bugly_5.png" alt="在这里插入图片描述"></p><p>图中第三步，可以修改更新提示框，例如：AppLike.class中的Beta.upgradeDialogLayoutId = R.layout.upgrade_dialog;<br>只需在项目中新建一个布局，不过那些按钮等都要设置对应的tag，才会起作用，具体看<a href="https://bugly.qq.com/docs/user-guide/advance-features-android-beta/?v=20180709165613" target="_blank" rel="noopener">Bugly Android 应用升级 SDK 高级配置</a></p><p>特别要注意的是：打包成功之后，最好把app-0710-18-39-06文件夹保存起来。为什么？</p><p>比如现在版本上线，突然出现一个重大bug，这时候可以选择用热更新进行修复。你也不用重新多弄个版本，用户也不用去重新下载apk。</p><p><strong>然后项目打补丁包，需要如下配置</strong></p><blockquote><p>def baseApkDir = “app-0710-18-39-06”  </p></blockquote><p>这里的app-0710-18-39-06就是刚刚说要保存的基准包对应的文件名</p><p>弄完之后就上传补丁包，如下图<br><img src="/images/article/bugly_6.png" alt="在这里插入图片描述"></p><p>一般确认无误的情况，下发范围都是选择全部设备。</p><p>如果你想选择开发设备进行补丁包测试的话，那么又要修改如下配置，首先修改 ext.log_debug = true。</p><p>打包app-0710-18-39-06（包1）：ext.log_debug = false（作为全部设备使用）<br>打包app-0710-18-40-40（包2）：ext.log_debug = true（作为开发设备使用）</p><p>这两个app-××× 都是相继打包出来的，也就是上面说的保存包1的时候，顺便改为true打包出包2，两个都一起保存起来，然后才有以下补丁包的说法。</p><p>具体流程如如下，画得有点丑，凑合着看呗（宝图哦）</p><p><img src="/images/article/bugly_7.png" alt="在这里插入图片描述"></p><hr><p><strong>最后经过多轮测试，发现打补丁时，baseApkDir必须是认准基准包的。而tinkerid可以不用是patch-versionname,但必须不能与之前的tinkerid重复。</strong></p><hr><p><a href="https://github.com/WShaobin/BuglyDemo/tree/master" target="_blank" rel="noopener">文章涉及到的Demo，已上传至github</a></p><hr><p>这里遇到一个坑，就是发布app之后，被“强制停止了”，然后重启提示“启动策略失败”。</p><p>原来是下发上限跟激活上限的问题，修改成100w就ok了<br><img src="/images/article/bugly_8.png" alt="在这里插入图片描述"></p><hr><p>以上都是本人的一些见解，如有误点请帮忙指正，谢谢！！</p><p>看到这里的话，累了吧，分享个小姐姐给你认识</p><p><img src="/images/article/bugly_9.jpg" alt="在这里插入图片描述"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;经过去年的九月份至现在，发现自己很久没有写过比较好的文章了。今天就趁着通宵的劲，写一下对腾讯Bugly的应用升级&amp;amp;热更新的理解，希望对新手有所帮助，有兴趣的可以了解下，没兴趣的也可以看完之后吐槽我。。。&lt;/p&gt;
    
    </summary>
    
      <category term="Android" scheme="https://wshaobin.github.io/categories/Android/"/>
    
    
      <category term="Android" scheme="https://wshaobin.github.io/tags/Android/"/>
    
      <category term="Bugly" scheme="https://wshaobin.github.io/tags/Bugly/"/>
    
  </entry>
  
</feed>
